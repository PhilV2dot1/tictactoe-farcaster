<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic Tac Toe - Celo</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #FCFF52 0%, #FFE55C 100%);
            min-height: 100vh;
            color: #1A1A1A;
        }

        .app {
            max-width: 500px;
            margin: 0 auto;
            padding: 16px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .logo {
            font-size: 3em;
            margin-bottom: 8px;
        }

        .title {
            font-size: 1.8em;
            font-weight: 700;
            background: linear-gradient(135deg, #35D07F 0%, #2AB56F 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            background: rgba(53, 208, 127, 0.2);
            color: #2AB56F;
            font-size: 0.8em;
            font-weight: 600;
        }

        .mode-toggle {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            background: white;
            padding: 8px;
            border-radius: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }

        .mode-btn {
            padding: 14px;
            border: none;
            background: transparent;
            color: #666;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #35D07F 0%, #2AB56F 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(53, 208, 127, 0.3);
        }

        .wallet-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            display: none;
        }

        .wallet-card.show {
            display: block;
        }

        .wallet-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 8px;
        }

        .wallet-address {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            background: rgba(53, 208, 127, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #35D07F 0%, #2AB56F 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #FF5252 0%, #e04545 100%);
            color: white;
        }

        .game-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .status {
            background: rgba(53, 208, 127, 0.15);
            border-left: 4px solid #35D07F;
            padding: 14px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
            font-size: 0.95em;
        }

        .status.win {
            background: rgba(76, 175, 80, 0.15);
            border-left-color: #4CAF50;
        }

        .status.lose {
            background: rgba(255, 82, 82, 0.15);
            border-left-color: #FF5252;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
            max-width: 350px;
            margin-left: auto;
            margin-right: auto;
        }

        .cell {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #FFFFFF 0%, #F5F5F5 100%);
            border: 3px solid rgba(53, 208, 127, 0.3);
            border-radius: 16px;
            font-size: 3em;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .cell:hover:not(.filled) {
            transform: scale(1.05);
            background: rgba(53, 208, 127, 0.1);
        }

        .cell.filled {
            cursor: not-allowed;
        }

        .cell.x {
            color: #35D07F;
        }

        .cell.o {
            color: #FBCC5C;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .stats {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }

        .stats-header {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .stat-card {
            background: #F8F8F8;
            border-radius: 12px;
            padding: 14px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #35D07F;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.75em;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <div class="logo">üéÆ</div>
            <h1 class="title">Tic Tac Toe</h1>
            <span class="badge">Celo Alfajores</span>
        </div>

        <div class="mode-toggle">
            <button class="mode-btn active" id="freeBtn">
                üéØ Free Play
            </button>
            <button class="mode-btn" id="chainBtn">
                ‚õìÔ∏è On-Chain
            </button>
        </div>

        <div class="wallet-card" id="walletCard">
            <div class="wallet-label" id="walletLabel">Not connected</div>
            <div class="wallet-address" id="walletAddress" style="display:none;"></div>
            <button class="btn btn-primary" id="connectBtn">
                Connect Wallet
            </button>
        </div>

        <div class="game-card">
            <div class="status" id="status">
                Click Start to begin! üöÄ
            </div>

            <div class="board" id="board"></div>

            <div class="controls">
                <button class="btn btn-success" id="startBtn">
                    Start Game
                </button>
                <button class="btn btn-danger" id="resetBtn" disabled>
                    Reset
                </button>
            </div>
        </div>

        <div class="stats">
            <div class="stats-header">üìä Your Stats</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="statGames">0</div>
                    <div class="stat-label">Games</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statWins">0</div>
                    <div class="stat-label">Wins</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statLosses">0</div>
                    <div class="stat-label">Losses</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Farcaster SDK - CRITIAL pour que l'app se charge -->
    <script type="module">
        import sdk from 'https://farcaster.xyz/v0.19.0/farcaster.js';
        
        // ESSENTIEL: Appeler ready() imm√©diatement pour enlever le splash screen
        sdk.actions.ready();
        console.log('‚úÖ Farcaster SDK ready called');
        
        // Exposer globalement
        window.farcasterSDK = sdk;
        
        // R√©cup√©rer le contexte
        sdk.context.then(context => {
            console.log('üì± Farcaster context:', context);
            window.farcasterContext = context;
        }).catch(e => console.log('Not in frame'));
    </script>

    <!-- Ethers.js -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <script>
        // Config
        const CONTRACT_ADDRESS = "0xD92BcD223Aa2A9818CbeB853b1d2beAa9eaf3008";
        const CELO_ALFAJORES = {
            chainId: 44787,
            chainIdHex: '0xaef3',
            name: 'Celo Alfajores',
            rpcUrl: 'https://alfajores-forno.celo-testnet.org'
        };

        const ABI = [
            "function startGame() external",
            "function makeMove(uint8 position) external",
            "function getBoard(address player) external view returns (uint8[9])"
        ];

        // √âtat
        let mode = 'free';
        let connected = false;
        let provider, contract, address;
        let board = [0,0,0,0,0,0,0,0,0];
        let active = false;
        let processing = false;
        let stats = { games: 0, wins: 0, losses: 0 };

        // DOM
        const freeBtn = document.getElementById('freeBtn');
        const chainBtn = document.getElementById('chainBtn');
        const walletCard = document.getElementById('walletCard');
        const walletLabel = document.getElementById('walletLabel');
        const walletAddress = document.getElementById('walletAddress');
        const connectBtn = document.getElementById('connectBtn');
        const status = document.getElementById('status');
        const boardEl = document.getElementById('board');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');

        // Init
        function init() {
            console.log('üéÆ Initializing app...');
            
            // Cr√©er plateau
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.onclick = () => makeMove(i);
                boardEl.appendChild(cell);
            }

            // Events
            freeBtn.onclick = () => switchMode('free');
            chainBtn.onclick = () => switchMode('chain');
            connectBtn.onclick = connectWallet;
            startBtn.onclick = startGame;
            resetBtn.onclick = resetGame;

            // Stats
            const saved = localStorage.getItem('stats');
            if (saved) {
                stats = JSON.parse(saved);
                updateStats();
            }

            console.log('‚úÖ App initialized');
        }

        function switchMode(m) {
            mode = m;
            freeBtn.classList.toggle('active', m === 'free');
            chainBtn.classList.toggle('active', m === 'chain');
            walletCard.classList.toggle('show', m === 'chain');
            resetGame();
        }

        async function connectWallet() {
            if (processing) return;
            processing = true;

            try {
                setStatus('Connecting... üîó');
                connectBtn.disabled = true;
                connectBtn.textContent = 'Connecting...';

                if (!window.ethereum) {
                    throw new Error('No wallet found');
                }

                console.log('üîå Requesting accounts...');
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                address = accounts[0];
                console.log('‚úÖ Connected:', address);

                provider = new ethers.providers.Web3Provider(window.ethereum);
                
                // Switch to Celo
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: CELO_ALFAJORES.chainIdHex }]
                    });
                } catch (e) {
                    if (e.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: CELO_ALFAJORES.chainIdHex,
                                chainName: CELO_ALFAJORES.name,
                                nativeCurrency: { name: 'CELO', symbol: 'CELO', decimals: 18 },
                                rpcUrls: [CELO_ALFAJORES.rpcUrl]
                            }]
                        });
                    }
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider.getSigner());

                connected = true;
                walletLabel.textContent = 'üü£ Connected';
                walletAddress.textContent = address.slice(0,6) + '...' + address.slice(-4);
                walletAddress.style.display = 'block';
                connectBtn.style.display = 'none';
                setStatus('Connected! üéâ', 'win');

            } catch (e) {
                console.error(e);
                setStatus('Connection failed üòû', 'lose');
                connectBtn.textContent = 'Retry';
                connectBtn.disabled = false;
            } finally {
                processing = false;
            }
        }

        async function startGame() {
            if (processing || active) return;
            if (mode === 'chain' && !connected) {
                setStatus('Connect wallet first! üëõ', 'lose');
                return;
            }

            processing = true;

            try {
                if (mode === 'chain') {
                    setStatus('Starting on-chain... ‚è≥');
                    const tx = await contract.startGame({ gasLimit: 500000 });
                    setStatus('Confirming... ‚è≥');
                    await tx.wait();
                    console.log('‚úÖ Started');
                }

                board = [0,0,0,0,0,0,0,0,0];
                active = true;
                updateBoard();
                setStatus('Your turn! üëÜ');
                startBtn.disabled = true;
                resetBtn.disabled = false;

            } catch (e) {
                console.error(e);
                setStatus('Failed to start üòû', 'lose');
            } finally {
                processing = false;
            }
        }

        async function makeMove(pos) {
            if (!active || board[pos] !== 0 || processing) return;
            processing = true;

            try {
                if (mode === 'chain') {
                    setStatus('Your move... ‚è≥');
                    const tx = await contract.makeMove(pos, { gasLimit: 500000 });
                    setStatus('AI thinking... ü§ñ');
                    await tx.wait();
                    
                    const b = await contract.getBoard(address);
                    board = b.map(c => parseInt(c.toString()));
                    updateBoard();

                    if (checkWin(1)) endGame('win');
                    else if (checkWin(2)) endGame('lose');
                    else if (board.every(c => c !== 0)) endGame('draw');
                    else setStatus('Your turn! üëÜ');

                } else {
                    board[pos] = 1;
                    updateBoard();

                    if (checkWin(1)) {
                        endGame('win');
                        processing = false;
                        return;
                    }

                    if (board.every(c => c !== 0)) {
                        endGame('draw');
                        processing = false;
                        return;
                    }

                    setStatus('AI thinking... ü§î');
                    setTimeout(() => {
                        const ai = getAI();
                        board[ai] = 2;
                        updateBoard();

                        if (checkWin(2)) endGame('lose');
                        else if (board.every(c => c !== 0)) endGame('draw');
                        else setStatus('Your turn! üëÜ');
                        
                        processing = false;
                    }, 500);
                    return;
                }

            } catch (e) {
                console.error(e);
                setStatus('Move failed üòû', 'lose');
            } finally {
                if (mode === 'chain') processing = false;
            }
        }

        function getAI() {
            // Win
            for (let i = 0; i < 9; i++) {
                if (board[i] === 0) {
                    board[i] = 2;
                    if (checkWin(2)) { board[i] = 0; return i; }
                    board[i] = 0;
                }
            }
            // Block
            for (let i = 0; i < 9; i++) {
                if (board[i] === 0) {
                    board[i] = 1;
                    if (checkWin(1)) { board[i] = 0; return i; }
                    board[i] = 0;
                }
            }
            // Center
            if (board[4] === 0) return 4;
            // Corner
            for (let c of [0,2,6,8]) {
                if (board[c] === 0) return c;
            }
            // Any
            for (let i = 0; i < 9; i++) {
                if (board[i] === 0) return i;
            }
            return 0;
        }

        function checkWin(p) {
            const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            return lines.some(l => l.every(i => board[i] === p));
        }

        function endGame(result) {
            active = false;
            startBtn.disabled = false;
            
            if (mode === 'free') {
                stats.games++;
                if (result === 'win') {
                    stats.wins++;
                    setStatus('üéâ You Win!', 'win');
                } else if (result === 'lose') {
                    stats.losses++;
                    setStatus('üò¢ AI Wins', 'lose');
                } else {
                    setStatus('ü§ù Draw');
                }
                localStorage.setItem('stats', JSON.stringify(stats));
                updateStats();
            } else {
                if (result === 'win') setStatus('üéâ You Win!', 'win');
                else if (result === 'lose') setStatus('üò¢ AI Wins', 'lose');
                else setStatus('ü§ù Draw');
            }
        }

        function resetGame() {
            board = [0,0,0,0,0,0,0,0,0];
            active = false;
            updateBoard();
            setStatus('Click Start! üöÄ');
            startBtn.disabled = false;
            resetBtn.disabled = true;
        }

        function updateBoard() {
            const cells = boardEl.children;
            for (let i = 0; i < 9; i++) {
                cells[i].textContent = board[i] === 1 ? 'X' : board[i] === 2 ? 'O' : '';
                cells[i].className = 'cell' + 
                    (board[i] !== 0 ? ' filled' : '') +
                    (board[i] === 1 ? ' x' : board[i] === 2 ? ' o' : '');
            }
        }

        function setStatus(msg, type = '') {
            status.textContent = msg;
            status.className = 'status ' + type;
        }

        function updateStats() {
            document.getElementById('statGames').textContent = stats.games;
            document.getElementById('statWins').textContent = stats.wins;
            document.getElementById('statLosses').textContent = stats.losses;
        }

        // Start
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>