<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic Tac Toe - Celo</title>

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Tic Tac Toe on Celo" />
    <meta property="og:description" content="Play Tic Tac Toe on-chain! Free mode or compete on the blockchain leaderboard." />
    <meta property="og:image" content="https://tictactoe-farcaster.vercel.app/frame-preview.png" />
    <meta property="og:url" content="https://tictactoe-farcaster.vercel.app" />
    <meta property="og:type" content="website" />

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Tic Tac Toe on Celo" />
    <meta name="twitter:description" content="Play Tic Tac Toe on-chain! Free or On-Chain mode." />
    <meta name="twitter:image" content="https://tictactoe-farcaster.vercel.app/frame-preview.png" />

    <!-- Farcaster Frame Meta Tags -->
    <meta property="fc:frame" content="vNext" />
    <meta property="fc:frame:image" content="https://tictactoe-farcaster.vercel.app/frame-preview.png" />
    <meta property="fc:frame:image:aspect_ratio" content="1:1" />

    <!-- Farcaster Manifest -->
    <link rel="manifest" href="/.well-known/farcaster.json" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #FCFF52 0%, #FFE55C 100%);
            min-height: 100vh;
            color: #1A1A1A;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .logo {
            font-size: 3em;
            margin-bottom: 8px;
        }

        .title {
            font-size: 2em;
            font-weight: 700;
            background: linear-gradient(135deg, #35D07F 0%, #2AB56F 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 4px;
        }

        .network-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 12px;
            background: rgba(53, 208, 127, 0.2);
            color: #2AB56F;
            font-size: 0.85em;
            font-weight: 600;
        }

        .mode-toggle {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            background: white;
            padding: 8px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }

        .mode-btn {
            padding: 16px;
            border: none;
            background: transparent;
            color: #666;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #35D07F 0%, #2AB56F 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(53, 208, 127, 0.3);
        }

        .wallet-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            display: none;
        }

        .wallet-card.show {
            display: block;
        }

        .wallet-info {
            margin-bottom: 12px;
        }

        .wallet-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
        }

        .wallet-address {
            font-family: 'Courier New', monospace;
            background: rgba(53, 208, 127, 0.1);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.95em;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #35D07F 0%, #2AB56F 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #FF5252 0%, #e04545 100%);
            color: white;
        }

        .game-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .status {
            background: rgba(53, 208, 127, 0.15);
            border-left: 4px solid #35D07F;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            font-weight: 600;
            text-align: center;
        }

        .status.win {
            background: rgba(76, 175, 80, 0.15);
            border-left-color: #4CAF50;
        }

        .status.lose {
            background: rgba(255, 82, 82, 0.15);
            border-left-color: #FF5252;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
            max-width: 350px;
            margin-left: auto;
            margin-right: auto;
        }

        .cell {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #FFFFFF 0%, #F5F5F5 100%);
            border: 3px solid rgba(53, 208, 127, 0.3);
            border-radius: 16px;
            font-size: 3em;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            user-select: none;
        }

        .cell:hover:not(.filled) {
            transform: scale(1.05);
            background: rgba(53, 208, 127, 0.1);
        }

        .cell.filled {
            cursor: not-allowed;
        }

        .cell.x {
            color: #35D07F;
        }

        .cell.o {
            color: #FBCC5C;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .stats {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .stats-header {
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        @media (min-width: 400px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .stat-card {
            background: #F8F8F8;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #35D07F;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.75em;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
        }

        .share-section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            text-align: center;
        }

        .share-title {
            font-size: 1em;
            font-weight: 700;
            margin-bottom: 12px;
            color: #1A1A1A;
        }

        .share-subtitle {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 16px;
        }

        .share-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üéÆ</div>
            <h1 class="title">Tic Tac Toe</h1>
            <span class="network-badge">Celo Mainnet</span>
        </div>

        <div class="mode-toggle">
            <button class="mode-btn active" id="freeBtn">
                üéØ Free Play
            </button>
            <button class="mode-btn" id="chainBtn">
                ‚õìÔ∏è On-Chain
            </button>
        </div>

        <div class="wallet-card" id="walletCard">
            <div class="wallet-info">
                <div class="wallet-label" id="walletLabel">Not connected</div>
                <div class="wallet-address" id="walletAddress" style="display:none;"></div>
            </div>
            <button class="btn btn-primary" id="connectBtn">
                Connect Wallet
            </button>
        </div>

        <div class="game-card">
            <div class="status" id="status">
                Click Start to begin! üöÄ
            </div>

            <div class="board" id="board"></div>

            <div class="controls">
                <button class="btn btn-success" id="startBtn">
                    Start Game
                </button>
                <button class="btn btn-danger" id="resetBtn" disabled>
                    Reset
                </button>
            </div>
        </div>

        <div class="share-section">
            <div class="share-title">üéØ Share Your Results</div>
            <div class="share-subtitle">Challenge your friends on Farcaster!</div>
            <div class="share-buttons">
                <button class="btn btn-secondary btn-icon" id="shareBtn">
                    <span>üü£</span>
                    <span>Share on Farcaster</span>
                </button>
            </div>
        </div>

        <div class="stats">
            <div class="stats-header">üìä Your Stats</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="statGames">0</div>
                    <div class="stat-label">Games</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statWins">0</div>
                    <div class="stat-label">Wins</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statLosses">0</div>
                    <div class="stat-label">Losses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statDraws">0</div>
                    <div class="stat-label">Draws</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Farcaster Frame SDK - Load synchronously -->
    <script type="module">
        // Import and initialize IMMEDIATELY
        const sdk = await import('https://esm.sh/@farcaster/frame-sdk@0.2.1');

        // Store SDK globally BEFORE calling ready
        window.farcasterSDK = sdk.default || sdk;
        window.farcasterReady = false;
        window.farcasterContext = null;
        window.farcasterUser = null;

        // Call ready() IMMEDIATELY - this is critical
        try {
            console.log('üîå Calling sdk.actions.ready()...');
            await window.farcasterSDK.actions.ready({});
            window.farcasterReady = true;
            console.log('‚úÖ Farcaster SDK ready');

            // Get context after ready
            try {
                const context = await window.farcasterSDK.context;
                window.farcasterContext = context;
                console.log('üì± Farcaster context:', context);

                // Store user info if available
                if (context && context.user) {
                    window.farcasterUser = context.user;
                    console.log('üë§ Farcaster user:', context.user.username);
                }

                // Add Ethereum provider from Farcaster
                if (window.farcasterSDK.wallet) {
                    console.log('üîå Farcaster wallet provider available');
                    window.ethereum = window.farcasterSDK.wallet.ethProvider || window.ethereum;
                }
            } catch (contextError) {
                console.log('‚ÑπÔ∏è Could not get Farcaster context:', contextError.message);
            }
        } catch (e) {
            console.log('‚ÑπÔ∏è Not in Farcaster frame, running standalone:', e.message);
            window.farcasterReady = false;
        }
    </script>

    <!-- Ethers.js -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        
        // Nouveau contrat simple (pas de fonds, juste tracking)
        const CONTRACT_ADDRESS = "0xa9596b4a5A7F0E10A5666a3a5106c4F2C3838881";
        
        const CELO_MAINNET = {
            chainId: 42220,
            chainIdHex: '0xa4ec',
            name: 'Celo',
            nativeCurrency: {
                name: 'CELO',
                symbol: 'CELO',
                decimals: 18
            },
            rpcUrls: ['https://forno.celo.org'],
            blockExplorerUrls: ['https://explorer.celo.org/mainnet']
        };

        // ABI simplifi√© pour le nouveau contrat
        const CONTRACT_ABI = [
            "function startGame() external",
            "function endGame(uint8 result) external",
            "function getPlayerStats(address player) external view returns (uint256 gamesPlayed, uint256 wins, uint256 losses, uint256 draws, uint256 winRate, uint256 currentStreak, uint256 bestStreak)",
            "function getPlayerGameCount(address player) external view returns (uint256)",
            "function totalGamesPlayed() external view returns (uint256)",
            "event GameStarted(address indexed player, uint256 gameId, uint256 timestamp)",
            "event GameCompleted(address indexed player, uint256 gameId, uint8 result)"
        ];

        // ============================================
        // STATE
        // ============================================
        let gameState = {
            mode: 'free',
            connected: false,
            provider: null,
            contract: null,
            address: null,
            board: [0,0,0,0,0,0,0,0,0],
            active: false,
            processing: false,
            gameStartedOnChain: false,
            stats: { games: 0, wins: 0, losses: 0, draws: 0 }
        };

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const elements = {
            freeBtn: document.getElementById('freeBtn'),
            chainBtn: document.getElementById('chainBtn'),
            walletCard: document.getElementById('walletCard'),
            walletLabel: document.getElementById('walletLabel'),
            walletAddress: document.getElementById('walletAddress'),
            connectBtn: document.getElementById('connectBtn'),
            status: document.getElementById('status'),
            board: document.getElementById('board'),
            startBtn: document.getElementById('startBtn'),
            resetBtn: document.getElementById('resetBtn'),
            shareBtn: document.getElementById('shareBtn')
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        function init() {
            console.log('üéÆ Initializing Tic Tac Toe on Celo...');
            console.log('üìù Contract:', CONTRACT_ADDRESS);
            console.log('üîó Explorer:', CELO_MAINNET.blockExplorerUrls[0] + '/address/' + CONTRACT_ADDRESS);

            // Check if running in Farcaster frame
            if (window.farcasterReady && window.farcasterContext) {
                console.log('üü£ Running in Farcaster frame');
                if (window.farcasterUser) {
                    console.log('üë§ User:', window.farcasterUser.username);
                }
            } else {
                console.log('üåê Running in standalone mode');
            }

            // Create board
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.index = i;
                cell.onclick = () => handleMove(i);
                elements.board.appendChild(cell);
            }

            // Events
            elements.freeBtn.onclick = () => switchMode('free');
            elements.chainBtn.onclick = () => switchMode('chain');
            elements.connectBtn.onclick = connectWallet;
            elements.startBtn.onclick = startGame;
            elements.resetBtn.onclick = resetGame;
            elements.shareBtn.onclick = shareResults;

            // Load stats
            const saved = localStorage.getItem('tictactoe_celo_stats');
            if (saved) {
                gameState.stats = JSON.parse(saved);
                updateStatsDisplay();
            }

            console.log('‚úÖ App initialized');
        }

        // ============================================
        // WALLET CONNECTION
        // ============================================
        async function connectWallet() {
            if (gameState.processing) return;
            gameState.processing = true;

            try {
                setStatus('Connecting to Farcaster wallet... üîó');
                elements.connectBtn.disabled = true;
                elements.connectBtn.textContent = 'Connecting...';

                // Wait for SDK to be ready if in frame
                if (window.farcasterSDK && !window.farcasterReady) {
                    console.log('‚è≥ Waiting for Farcaster SDK to be ready...');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                // Try to get Ethereum provider
                let provider = window.ethereum;

                // If in Farcaster frame, use SDK wallet
                if (window.farcasterSDK && window.farcasterSDK.wallet) {
                    console.log('üîå Using Farcaster wallet provider');
                    provider = window.farcasterSDK.wallet.ethProvider;

                    if (!provider) {
                        console.warn('‚ö†Ô∏è No ethProvider in Farcaster SDK, falling back to window.ethereum');
                        provider = window.ethereum;
                    }
                }

                if (!provider) {
                    throw new Error('No wallet found. Please open in Farcaster app or connect MetaMask.');
                }

                console.log('üîå Requesting accounts...');
                const accounts = await provider.request({
                    method: 'eth_requestAccounts'
                });

                if (!accounts || accounts.length === 0) {
                    throw new Error('No accounts returned');
                }

                gameState.address = accounts[0];
                console.log('‚úÖ Connected:', gameState.address);

                gameState.provider = new ethers.providers.Web3Provider(provider);

                // Check/Switch network
                const network = await gameState.provider.getNetwork();
                console.log('üåê Current network:', network.chainId);

                if (network.chainId !== CELO_MAINNET.chainId) {
                    console.log('‚ö†Ô∏è Switching to Celo...');
                    setStatus('Switching to Celo... üîÑ');

                    try {
                        await provider.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: CELO_MAINNET.chainIdHex }]
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902 || switchError.code === -32603) {
                            await provider.request({
                                method: 'wallet_addEthereumChain',
                                params: [CELO_MAINNET]
                            });
                        } else {
                            throw switchError;
                        }
                    }

                    gameState.provider = new ethers.providers.Web3Provider(provider);
                }

                // Balance
                const balance = await gameState.provider.getBalance(gameState.address);
                const balanceInCelo = parseFloat(ethers.utils.formatEther(balance));
                console.log('üí∞ Balance:', balanceInCelo.toFixed(4), 'CELO');

                // Contract
                const signer = gameState.provider.getSigner();
                gameState.contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                console.log('‚úÖ Contract connected');

                // Test contract
                try {
                    const totalGames = await gameState.contract.totalGamesPlayed();
                    console.log('‚úÖ Contract valid. Total games:', totalGames.toString());
                } catch (e) {
                    console.error('‚ùå Contract test failed:', e);
                    throw new Error('Contract not responding. Please verify the contract address.');
                }

                // Update UI
                gameState.connected = true;
                const walletType = (window.farcasterReady && window.farcasterContext) ? 'Farcaster' : 'Web3';
                elements.walletLabel.textContent = `üü£ ${walletType} Wallet Connected`;
                elements.walletAddress.textContent =
                    gameState.address.slice(0, 6) + '...' + gameState.address.slice(-4);
                elements.walletAddress.style.display = 'block';
                elements.connectBtn.style.display = 'none';

                // Load stats
                await loadOnChainStats();

                if (balanceInCelo < 0.01) {
                    setStatus('‚ö†Ô∏è Low CELO balance. You need CELO to record games.', 'lose');
                } else {
                    setStatus('üéâ Connected! Ready to play on-chain', 'win');
                }

            } catch (error) {
                console.error('‚ùå Connection error:', error);
                
                let errorMsg = 'Connection failed';
                if (error.message.includes('rejected') || error.message.includes('denied')) {
                    errorMsg = 'Connection rejected';
                } else if (error.message.includes('No wallet')) {
                    errorMsg = error.message;
                }
                
                setStatus(errorMsg + ' üòû', 'lose');
                elements.connectBtn.textContent = 'Retry';
                elements.connectBtn.disabled = false;
            } finally {
                gameState.processing = false;
            }
        }

        // ============================================
        // GAME LOGIC
        // ============================================
        async function startGame() {
            if (gameState.processing || gameState.active) return;

            if (gameState.mode === 'chain' && !gameState.connected) {
                setStatus('Please connect wallet first! üëõ', 'lose');
                return;
            }

            gameState.processing = true;

            try {
                if (gameState.mode === 'chain') {
                    setStatus('Recording game start on blockchain... ‚è≥');
                    elements.startBtn.textContent = 'Recording...';

                    const tx = await gameState.contract.startGame();
                    console.log('üì§ Start game tx:', tx.hash);
                    
                    await tx.wait();
                    console.log('‚úÖ Game recorded on-chain');
                    
                    gameState.gameStartedOnChain = true;
                }

                // Reset board and start
                gameState.board = [0,0,0,0,0,0,0,0,0];
                gameState.active = true;
                updateBoard();
                
                setStatus('Your turn! Tap a cell üëÜ');
                elements.startBtn.disabled = true;
                elements.resetBtn.disabled = false;

            } catch (error) {
                console.error('‚ùå Start error:', error);
                
                let errorMsg = 'Failed to start game';
                if (error.message && error.message.includes('rejected')) {
                    errorMsg = 'Transaction rejected';
                } else if (error.message && error.message.includes('insufficient funds')) {
                    errorMsg = 'Insufficient CELO for gas';
                }
                
                setStatus(errorMsg + ' üòû', 'lose');
            } finally {
                gameState.processing = false;
                elements.startBtn.textContent = 'Start Game';
            }
        }

        async function handleMove(position) {
            if (!gameState.active || gameState.board[position] !== 0 || gameState.processing) {
                return;
            }

            gameState.processing = true;

            // Player move
            gameState.board[position] = 1;
            updateBoard();

            // Check win
            if (checkWin(1)) {
                await endGame('win');
                gameState.processing = false;
                return;
            }

            // Check draw
            if (gameState.board.every(c => c !== 0)) {
                await endGame('draw');
                gameState.processing = false;
                return;
            }

            // AI move
            setStatus('AI thinking... ü§î');

            setTimeout(async () => {
                const aiMove = getAIMove();
                gameState.board[aiMove] = 2;
                updateBoard();

                if (checkWin(2)) {
                    await endGame('lose');
                } else if (gameState.board.every(c => c !== 0)) {
                    await endGame('draw');
                } else {
                    setStatus('Your turn! üëÜ');
                }
                
                gameState.processing = false;
            }, 600);
        }

        // ============================================
        // AI LOGIC
        // ============================================
        function getAIMove() {
            // Try to win
            for (let i = 0; i < 9; i++) {
                if (gameState.board[i] === 0) {
                    gameState.board[i] = 2;
                    if (checkWin(2)) {
                        gameState.board[i] = 0;
                        return i;
                    }
                    gameState.board[i] = 0;
                }
            }

            // Block player
            for (let i = 0; i < 9; i++) {
                if (gameState.board[i] === 0) {
                    gameState.board[i] = 1;
                    if (checkWin(1)) {
                        gameState.board[i] = 0;
                        return i;
                    }
                    gameState.board[i] = 0;
                }
            }

            // Center
            if (gameState.board[4] === 0) return 4;

            // Corner
            const corners = [0, 2, 6, 8];
            for (let c of corners) {
                if (gameState.board[c] === 0) return c;
            }

            // Any
            for (let i = 0; i < 9; i++) {
                if (gameState.board[i] === 0) return i;
            }

            return 0;
        }

        function checkWin(player) {
            const lines = [
                [0,1,2], [3,4,5], [6,7,8],
                [0,3,6], [1,4,7], [2,5,8],
                [0,4,8], [2,4,6]
            ];
            return lines.some(line => line.every(i => gameState.board[i] === player));
        }

        // ============================================
        // END GAME
        // ============================================
        async function endGame(result) {
            gameState.active = false;
            elements.startBtn.disabled = false;

            if (gameState.mode === 'free') {
                // Free play: update local stats
                gameState.stats.games++;
                
                if (result === 'win') {
                    gameState.stats.wins++;
                    setStatus('üéâ Victory!', 'win');
                } else if (result === 'lose') {
                    gameState.stats.losses++;
                    setStatus('üò¢ AI Wins', 'lose');
                } else {
                    gameState.stats.draws++;
                    setStatus('ü§ù Draw!');
                }
                
                localStorage.setItem('tictactoe_celo_stats', JSON.stringify(gameState.stats));
                updateStatsDisplay();
            } else {
                // On-chain: record result
                await recordOnChainResult(result);
            }
        }

        async function recordOnChainResult(result) {
            if (!gameState.gameStartedOnChain) {
                // Game wasn't started on-chain, just show result
                if (result === 'win') setStatus('üéâ You Win!', 'win');
                else if (result === 'lose') setStatus('üò¢ AI Wins', 'lose');
                else setStatus('ü§ù Draw!');
                return;
            }

            try {
                // Convert result: win=1, lose=2, draw=3
                let resultCode;
                if (result === 'win') {
                    resultCode = 1;
                    setStatus('üéâ You Win! Recording on blockchain... ‚è≥', 'win');
                } else if (result === 'lose') {
                    resultCode = 2;
                    setStatus('üò¢ AI Wins! Recording on blockchain... ‚è≥', 'lose');
                } else {
                    resultCode = 3;
                    setStatus('ü§ù Draw! Recording on blockchain... ‚è≥');
                }

                const tx = await gameState.contract.endGame(resultCode);
                console.log('üì§ End game tx:', tx.hash);
                
                await tx.wait();
                console.log('‚úÖ Result recorded on-chain');
                
                gameState.gameStartedOnChain = false;

                // Load updated stats
                await loadOnChainStats();
                
                if (result === 'win') {
                    setStatus('üéâ Victory recorded on blockchain!', 'win');
                } else if (result === 'lose') {
                    setStatus('üò¢ AI Wins - recorded on blockchain', 'lose');
                } else {
                    setStatus('ü§ù Draw - recorded on blockchain');
                }
            } catch (error) {
                console.error('‚ùå Failed to record result:', error);
                setStatus('‚ö†Ô∏è Game finished but not recorded on-chain', 'lose');
                gameState.gameStartedOnChain = false;
            }
        }

        function resetGame() {
            if (gameState.processing) return;
            
            gameState.board = [0,0,0,0,0,0,0,0,0];
            gameState.active = false;
            gameState.gameStartedOnChain = false;
            updateBoard();
            setStatus('Click Start to begin! üöÄ');
            elements.startBtn.disabled = false;
            elements.resetBtn.disabled = true;
        }

        // ============================================
        // STATS
        // ============================================
        async function loadOnChainStats() {
            if (!gameState.contract || !gameState.address) return;

            try {
                const stats = await gameState.contract.getPlayerStats(gameState.address);
                
                // Stats order: gamesPlayed, wins, losses, draws, winRate, currentStreak, bestStreak
                document.getElementById('statGames').textContent = stats[0].toString();
                document.getElementById('statWins').textContent = stats[1].toString();
                document.getElementById('statLosses').textContent = stats[2].toString();
                document.getElementById('statDraws').textContent = stats[3].toString();
                
                console.log('‚úÖ On-chain stats loaded:', {
                    games: stats[0].toString(),
                    wins: stats[1].toString(),
                    losses: stats[2].toString(),
                    draws: stats[3].toString()
                });
            } catch (error) {
                console.error('‚ùå Failed to load stats:', error);
            }
        }

        // ============================================
        // UI HELPERS
        // ============================================
        function switchMode(mode) {
            gameState.mode = mode;
            elements.freeBtn.classList.toggle('active', mode === 'free');
            elements.chainBtn.classList.toggle('active', mode === 'chain');
            elements.walletCard.classList.toggle('show', mode === 'chain');
            
            resetGame();
            
            if (mode === 'free') {
                updateStatsDisplay();
            } else if (gameState.connected) {
                loadOnChainStats();
            }
        }

        function updateBoard() {
            const cells = elements.board.children;
            for (let i = 0; i < 9; i++) {
                const value = gameState.board[i];
                cells[i].textContent = value === 1 ? 'X' : value === 2 ? 'O' : '';
                cells[i].className = 'cell' +
                    (value !== 0 ? ' filled' : '') +
                    (value === 1 ? ' x' : value === 2 ? ' o' : '');
            }
        }

        function setStatus(msg, type = '') {
            elements.status.textContent = msg;
            elements.status.className = 'status ' + type;
        }

        function updateStatsDisplay() {
            document.getElementById('statGames').textContent = gameState.stats.games;
            document.getElementById('statWins').textContent = gameState.stats.wins;
            document.getElementById('statLosses').textContent = gameState.stats.losses;
            document.getElementById('statDraws').textContent = gameState.stats.draws;
        }

        // ============================================
        // SHARE FUNCTIONALITY
        // ============================================
        async function shareResults() {
            try {
                // Get current stats
                const stats = gameState.mode === 'chain' && gameState.connected
                    ? getOnChainStatsForShare()
                    : gameState.stats;

                // Create share text
                const winRate = stats.games > 0
                    ? ((stats.wins / stats.games) * 100).toFixed(0)
                    : 0;

                const shareText = `üéÆ I'm playing Tic Tac Toe on Celo!\n\nüìä My Stats:\nüéØ Games: ${stats.games}\nüèÜ Wins: ${stats.wins}\n‚ùå Losses: ${stats.losses}\nü§ù Draws: ${stats.draws}\nüìà Win Rate: ${winRate}%\n\n${gameState.mode === 'chain' ? '‚õìÔ∏è Playing on-chain with verified results!\n' : ''}Can you beat me? üëá`;

                // Get app URL
                const appUrl = window.location.href;

                // If in Farcaster frame, use SDK to share
                if (window.farcasterSDK && window.farcasterReady) {
                    try {
                        console.log('üì§ Sharing via Farcaster SDK');

                        // Use Farcaster SDK actions to open composer
                        await window.farcasterSDK.actions.openUrl(`https://warpcast.com/~/compose?text=${encodeURIComponent(shareText)}&embeds[]=${encodeURIComponent(appUrl)}`);

                        setStatus('Share opened in Farcaster! üöÄ', 'win');
                        console.log('‚úÖ Share opened via SDK');
                        return;
                    } catch (sdkError) {
                        console.warn('‚ö†Ô∏è SDK share failed, trying fallback:', sdkError);
                    }
                }

                // Fallback for non-frame context
                const farcasterShareUrl = `https://warpcast.com/~/compose?text=${encodeURIComponent(shareText)}&embeds[]=${encodeURIComponent(appUrl)}`;

                // Try window.open for standalone mode
                const opened = window.open(farcasterShareUrl, '_blank');

                if (opened) {
                    console.log('üì§ Share opened in new window');
                    setStatus('Share window opened! üöÄ', 'win');
                } else {
                    // If blocked, copy to clipboard
                    console.log('‚ö†Ô∏è Popup blocked, copying to clipboard');
                    copyToClipboard();
                }

            } catch (error) {
                console.error('‚ùå Share error:', error);

                // Fallback: copy to clipboard
                copyToClipboard();
            }
        }

        function getOnChainStatsForShare() {
            // Get stats from displayed values
            return {
                games: parseInt(document.getElementById('statGames').textContent) || 0,
                wins: parseInt(document.getElementById('statWins').textContent) || 0,
                losses: parseInt(document.getElementById('statLosses').textContent) || 0,
                draws: parseInt(document.getElementById('statDraws').textContent) || 0
            };
        }

        function copyToClipboard() {
            try {
                const stats = gameState.mode === 'chain' && gameState.connected
                    ? getOnChainStatsForShare()
                    : gameState.stats;

                const winRate = stats.games > 0
                    ? ((stats.wins / stats.games) * 100).toFixed(0)
                    : 0;

                const shareText = `üéÆ I'm playing Tic Tac Toe on Celo!\n\nüìä My Stats:\nüéØ Games: ${stats.games}\nüèÜ Wins: ${stats.wins}\n‚ùå Losses: ${stats.losses}\nü§ù Draws: ${stats.draws}\nüìà Win Rate: ${winRate}%\n\n${gameState.mode === 'chain' ? '‚õìÔ∏è Playing on-chain!\n' : ''}${window.location.href}`;

                // Copy to clipboard
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(shareText).then(() => {
                        setStatus('‚úÖ Results copied! Paste in Farcaster to share', 'win');
                        console.log('‚úÖ Copied to clipboard');
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        setStatus('‚ö†Ô∏è Could not copy to clipboard', 'lose');
                    });
                } else {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = shareText;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        setStatus('‚úÖ Results copied! Paste in Farcaster to share', 'win');
                        console.log('‚úÖ Copied to clipboard (fallback)');
                    } catch (err) {
                        console.error('Failed to copy (fallback):', err);
                        setStatus('‚ö†Ô∏è Could not copy to clipboard', 'lose');
                    }
                    document.body.removeChild(textArea);
                }
            } catch (error) {
                console.error('‚ùå Clipboard error:', error);
                setStatus('‚ö†Ô∏è Share failed', 'lose');
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        function setupWalletListeners() {
            const provider = window.ethereum || (window.farcasterSDK?.wallet?.ethProvider);

            if (provider && provider.on) {
                provider.on('accountsChanged', (accounts) => {
                    console.log('üîÑ Account changed:', accounts);
                    if (accounts.length === 0 || accounts[0] !== gameState.address) {
                        console.log('Reloading due to account change...');
                        window.location.reload();
                    }
                });

                provider.on('chainChanged', (chainId) => {
                    console.log('üîÑ Chain changed:', chainId);
                    window.location.reload();
                });
            }
        }

        // Setup listeners after a short delay to ensure SDK is ready
        setTimeout(setupWalletListeners, 1000);

        // ============================================
        // START
        // ============================================
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        console.log('üéÆ Tic Tac Toe ready! Contract:', CONTRACT_ADDRESS);
    </script>
</body>
</html>